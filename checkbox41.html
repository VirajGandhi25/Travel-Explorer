<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Itinerary Planner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.0/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        $(function() {
            // Retrieve location parameter from URL
            const urlParams = new URLSearchParams(window.location.search);
            const locationParam = urlParams.get('location');

            // Prefill the location input field
            $('#location').val(locationParam);

            const states = [
                "Andaman and Nicobar Islands", "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chandigarh", "Chhattisgarh", "Dadra and Nagar Haveli", "Daman and Diu", "Delhi", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jammu and Kashmir", "Jharkhand", "Karnataka", "Kerala", "Ladakh", "Lakshadweep", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Puducherry", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
            ];

            $("#location").autocomplete({
                source: states
            });
        });
    </script>
</head>
<body>
    <h1>Tour Itinerary Planner</h1>
    <!-- <label for="location">Searched Location:</label> -->
    <input type="text" id="location" name="location" placeholder="Where do you want to go? ">
    <!-- <button id="getCoordinatesBtn">Get Coordinates</button>
    <button id="showNearbyPlacesBtn" style="display: none;">Show Nearby Places</button> -->
    <button id="getCoordinatesAndPlacesBtn">Get Coordinates & Show Nearby Places</button>
    
    <button id="exportToExcelBtn" style="display: none;">Export to Excel</button>
    <button id="selectDateBtn">Select Date and Company</button>

    <div id="coordinates"></div>
    <div id="categories"></div>

    <script>
        const apiKey = '5ae2e3f221c38a28845f05b6fb88108160b76562540d181f06c7fb96';
        let latitude, longitude; // Declare latitude and longitude variables to store coordinates
        let nearbyPlaces; // Declare variable to store fetched nearby places

        // Function to fetch coordinates for a location using OpenTripMap API
        async function getLocationCoordinates(location) {
            try {
                const response = await fetch(`http://api.opentripmap.com/0.1/en/places/geoname?name=${encodeURIComponent(location)}&apikey=${apiKey}`);
                const data = await response.json();
                if (data.lon && data.lat) {
                    latitude = data.lat; // Store latitude
                    longitude = data.lon; // Store longitude
                    return true;
                } else {
                    throw new Error('Coordinates not found for the location');
                }
            } catch (error) {
                console.error('Error:', error);
                throw new Error('Failed to fetch coordinates for the location');
            }
        }


            // Function to retrieve selected categories from URL parameters
        function getSelectedCategoriesFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const categoriesParam = urlParams.get('categories');
            if (categoriesParam) {
                return categoriesParam.split(','); // Split the comma-separated string into an array
            } else {
                return [];
            }
        }

        // Call the function to retrieve selected categories
        const selectedCategories = getSelectedCategoriesFromURL();
        

        // Function to fetch nearby places for the stored coordinates using OpenTripMap API
        async function getNearbyPlaces() {
            try {
                const radius = 30000; // Radius in kilometers
                const kinds = selectedCategories.join(',');
                console.log('Selected Categories:', kinds);

                const responseNearby = await fetch(`http://api.opentripmap.com/0.1/en/places/radius?radius=${radius}&lon=${longitude}&lat=${latitude}&kinds=${kinds}&hotels&apikey=${apiKey}`);
                const nearbyData = await responseNearby.json();
                return nearbyData.features.map(feature => ({
                    name: feature.properties.name,
                    image: feature.properties.image,
                    schema: categorizePlace(feature.properties.name),
                }));
            } catch (error) {
                console.error('Error:', error);
                throw new Error('Failed to fetch nearby places. Please try again.');
            }
        }

        // Function to categorize places based on their names
        function categorizePlace(name) {
            name = name.toLowerCase();
            if (name.includes('hotel')) {
                return 'Hotel';
            } else if (name.includes('restaurant') || name.includes('cafe') || name.includes('diner')) {
                return 'Restaurant';
            } else if (name.includes('temple')) {
                return 'Temple';
            } else if (name.includes('church')) {
                return 'Church';
            } else if (name.includes('accommodations') || name.includes('accommodation')) {
                return 'Accommodations';
            } else if (name.includes('theatre') || name.includes('cinema')) {
                return 'Theatre';
            } else if (name.includes('ashram')) {
                return 'Ashram';
            } else if (name.includes('palace')) {
                return 'Palace';
            } else if (name.includes('fort')) {
                return 'Fort';
            } else if (name.includes('station') || name.includes('railway') || name.includes('airport')) {
                return 'Station';
            } else if (name.includes('beach')) {
                return 'Beach';
            } else if (name.includes('memorial')) {
                return 'Memorial';
            } else if (name.includes('city')) {
                return 'City';
            } else {
                return 'Others';
            }
        }

        // Autocomplete for Indian states
        $(function() {
            const states = [
                "Andaman and Nicobar Islands", "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chandigarh", "Chhattisgarh", "Dadra and Nagar Haveli", "Daman and Diu", "Delhi", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jammu and Kashmir", "Jharkhand", "Karnataka", "Kerala", "Ladakh", "Lakshadweep", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Puducherry", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"
            ];
            $("#location").autocomplete({
                source: states
            });
        });

        // document.getElementById('getCoordinatesBtn').addEventListener('click', async function() {
        //     const locationInput = document.getElementById('location').value;
        //     try {
        //         const success = await getLocationCoordinates(locationInput);
        //         if (success) {
        //             document.getElementById('coordinates').innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;
        //             document.getElementById('showNearbyPlacesBtn').style.display = 'inline'; // Display the "Show Nearby Places" button
        //         }
        //     } catch (error) {
        //         console.error('Error:', error);
        //         alert('Failed to fetch coordinates for the location. Please try again.');
        //     }
        // });

        // document.getElementById('showNearbyPlacesBtn').addEventListener('click', async function() {
        //     try {
        //         nearbyPlaces = await getNearbyPlaces();
        //         displayCategories(groupPlacesByCategory(nearbyPlaces));
        //         document.getElementById('exportToExcelBtn').style.display = 'inline'; // Display the "Export to Excel" button
        //     } catch (error) {
        //         console.error('Error:', error);
        //         alert('Failed to fetch nearby places. Please try again.');
        //     }
        // });

        document.getElementById('getCoordinatesAndPlacesBtn').addEventListener('click', async function() {
            const locationInput = document.getElementById('location').value;
            try {
                const success = await getLocationCoordinates(locationInput);
                if (success) {
                    document.getElementById('coordinates').innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;
                    nearbyPlaces = await getNearbyPlaces();
                    displayCategories(groupPlacesByCategory(nearbyPlaces));
                    document.getElementById('exportToExcelBtn').style.display = 'inline'; // Display the "Export to Excel" button
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to fetch coordinates for the location. Please try again.');
            }
        });

        // Function to group places by category
        function groupPlacesByCategory(nearbyPlaces) {
            const categories = {};
            nearbyPlaces.forEach(place => {
                const category = place.schema;
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(place);
            });
            return categories;
        }

        // Function to display categorized places
function displayCategories(categories) {
    const categoriesContainer = document.getElementById('categories');
    categoriesContainer.innerHTML = ''; // Clear previous results

    for (const category in categories) {
        const categoryPlaces = categories[category];
        const categoryDiv = document.createElement('div');
        categoryDiv.innerHTML = `<h2>${category}</h2>`;
        const categoryList = document.createElement('ul');
        categoryList.style.listStyleType = 'none'; // Remove bullets
        categoryList.style.padding = '0'; // Remove default padding
        categoryList.style.margin = '0'; // Remove default margin
        categoryPlaces.forEach(place => {
            const listItem = document.createElement('li');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = place.name;
            checkbox.name = 'selectedPlaces';
            listItem.appendChild(checkbox);
            listItem.appendChild(document.createTextNode(place.name));
            listItem.style.margin = '0'; // Remove margin between list items
            categoryList.appendChild(listItem);
        });
        categoryDiv.appendChild(categoryList);
        categoriesContainer.appendChild(categoryDiv);
    }

    // Add button to save selected locations
    const saveButton = document.createElement('button');
    saveButton.textContent = 'Save Selected Locations';
    saveButton.addEventListener('click', function() {
        saveSelectedLocations();
    });
    categoriesContainer.appendChild(saveButton);
}

// Function to save selected locations to the database
function saveSelectedLocations() {
    const selectedLocations = Array.from(document.querySelectorAll('input[name="selectedPlaces"]:checked')).map(checkbox => checkbox.value);
    // Here, you can send the selectedLocations array to your server to store in the database
    console.log('Selected Locations:', selectedLocations);
    alert('Selected locations saved to database!');
}


        // Function to export data to Excel
        function exportToExcel(fileName) {
            const wb = XLSX.utils.book_new();
            const wsData = [];
            const headers = ['Category', 'Place Name'];

            wsData.push(headers);

            // Calculate the next available row dynamically
            let nextRow = 1;
            nearbyPlaces.forEach(place => {
                if (place.name.trim() !== '') {
                    wsData.push([place.schema, place.name]);
                    nextRow++;
                }
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            XLSX.utils.book_append_sheet(wb, ws, 'Nearby Places');

            // Write the workbook to the file
            XLSX.writeFile(wb, fileName);
        }

        document.getElementById('exportToExcelBtn').addEventListener('click', function() {
            const locationInput = document.getElementById('location').value.trim();
            if (locationInput !== '') {
                const fileName = `${locationInput}_nearby_places.xlsx`;
                exportToExcel(fileName);
            } else {
                alert('Please enter a location before exporting to Excel.');
            }
        });

        document.getElementById('selectDateBtn').addEventListener('click', function() {
            // Redirect to the new HTML page
            window.location.href = 'select_company5.html';
        });
    </script>
</body>
</html>
